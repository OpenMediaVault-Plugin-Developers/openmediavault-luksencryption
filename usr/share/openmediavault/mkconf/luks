#!/bin/bash
#
# This file is part of OpenMediaVault.
#
# @license   http://www.gnu.org/licenses/gpl.html GPL Version 3
# @author    Volker Theile <volker.theile@openmediavault.org>
# @author    OpenMediaVault Plugin Developers <plugins@omv-extras.org>
# @copyright Copyright (c) 2009-2015 Volker Theile
# @copyright Copyright (c) 2015 OpenMediaVault Plugin Developers
#
# OpenMediaVault is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# OpenMediaVault is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with OpenMediaVault. If not, see <http://www.gnu.org/licenses/>.

# Documentation/Howto:
# http://linux.die.net/man/8/cryptsetup
# http://linux.die.net/man/5/crypttab
# https://gitlab.com/cryptsetup/cryptsetup

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

OMV_LUKS_SECTIONNAME=${OMV_LUKS_SECTIONNAME:-"openmediavault"}

OMV_LUKS_CRYPTDISKS_DEFAULT=${OMV_LUKS_CRYPTDISKS_DEFAULT:-"/etc/default/cryptdisks"}
OMV_LUKS_CRYPTDISKS_INITSCRIPT=${OMV_LUKS_CRYPTDISKS_INITSCRIPT:-"/etc/init.d/cryptdisks"}
OMV_LUKS_CRYPTDISKS_EARLY_INITSCRIPT=${OMV_LUKS_CRYPTDISKS_EARLY_INITSCRIPT:-"/etc/init.d/cryptdisks-early"}
OMV_LUKS_CRYPTDISKS_ENABLE=${OMV_LUKS_CRYPTDISKS_ENABLE:-"Yes"}
OMV_LUKS_CRYPTDISKS_MOUNT=${OMV_LUKS_CRYPTDISKS_MOUNT:-""}

OMV_LUKS_CRYPTTAB_CONFIG=${OMV_LUKS_CRYPTTAB_CONFIG:-"/etc/crypttab"}
OMV_LUKS_CRYPTTAB_EXTENSIONS_DIR=${OMV_LUKS_CRYPTTAB_EXTENSIONS_DIR:-"${OMV_MKCONF_SCRIPTS_DIR}/crypttab.d"}


# Generate configuration files
mkconf() {
    #
    # Create the '/etc/crypttab' file.
    #

    # Execute all scripts building the custom crypttab configuration.
    crypttabcfg=$(echo -n "# >>> [${OMV_LUKS_SECTIONNAME}]\n"; run-parts --exit-on-error ${OMV_LUKS_CRYPTTAB_EXTENSIONS_DIR} | perl -p -e 's/\n/\\n/g'; echo -n "# <<< [${OMV_LUKS_SECTIONNAME}]")

    # Append custom crypttab configuration if not still present or replace existing one.
    if ! grep -E "^# >>> \[${OMV_LUKS_SECTIONNAME}\]\s*$" ${OMV_LUKS_CRYPTTAB_CONFIG} >/dev/null; then
    	echo -e "${crypttabcfg}" >> ${OMV_LUKS_CRYPTTAB_CONFIG}
    else
    	sed -i "/# >>> \[${OMV_LUKS_SECTIONNAME}\]/,/# <<< \[${OMV_LUKS_SECTIONNAME}\]/ c ${crypttabcfg}" ${OMV_LUKS_CRYPTTAB_CONFIG}
    fi


    #
    # Create the '/etc/default/cryptdisks' file.
    #
    cat > ${OMV_LUKS_CRYPTDISKS_DEFAULT} <<EOF
#
# /etc/default/cryptdisks for OpenMediaVault
# Do not edit this file, as it is automatically generated.
#

# Run cryptdisks initscripts at startup? Default is Yes.
CRYPTDISKS_ENABLE=${OMV_LUKS_CRYPTDISKS_ENABLE}

# Mountpoints to mount, before cryptsetup is invoked at initscripts. Takes
# mountpoins which are configured in /etc/fstab as arguments. Separate
# mountpoints by space.
# This is useful for keyfiles on removable media. Default is unset.
CRYPTDISKS_MOUNT="${OMV_LUKS_CRYPTDISKS_MOUNT}"

# Default check script. Takes effect, if the 'check' option is set in crypttab
# without a value.
CRYPTDISKS_CHECK=blkid

# Default precheck script. Takes effect, if the 'precheck' option is set in
# crypttab without a value.
# Default is 'un_blkid' for plain dm-crypt devices if unset here.
CRYPTDISKS_PRECHECK=
EOF

}


case "$1" in
mkconf|*)
    mkconf
    ;;
esac
exit 0
